<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>KABOOM – Simulation DESC</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; max-width: 600px; margin: auto; }
    h1, h2 { text-align: center; }
    input { width: 100%; padding: 10px; margin: 10px 0; font-size: 16px; }
    button { width: 100%; padding: 12px; margin-top: 10px; font-size: 16px; cursor: pointer; }
    .persona button { background: #f2f2f2; margin-top: 8px; }
    .hidden { display: none; }
    .status { margin-top: 10px; text-align: center; }
  </style>
</head>

<body>
  <h1>Simulation DESC</h1>

  <!-- ÉCRAN 1 : LICENCE -->
  <div id="step-licence">
    <label>Code d’accès</label>
    <input id="license" type="text" placeholder="TEST-001" />
    <button id="btn-validate" onclick="validateLicense()">Valider</button>
    <div id="status" class="status"></div>
  </div>

  <!-- ÉCRAN 2 : PERSONAS -->
  <div id="step-persona" class="hidden">
    <h2>Choisissez un collaborateur</h2>

    <div class="persona">
      <button onclick="choosePersona('normal')">Collaborateur normal</button>
      <button onclick="choosePersona('mauvaise_foi')">Mauvaise foi</button>
      <button onclick="choosePersona('agressif')">Agressif</button>
      <button onclick="choosePersona('silencieux')">Silencieux</button>
    </div>

    <button style="margin-top:16px;" onclick="resetFlow()">Changer de code</button>
  </div>

<script>
  const N8N_URL = "https://argelia-remanent-thistly.ngrok-free.dev/webhook/start_session";
  let LICENSE = "";

  function setStatus(msg, isError=false) {
    const el = document.getElementById("status");
    el.style.color = isError ? "red" : "green";
    el.innerText = msg || "";
  }

  function showLicense() {
    document.getElementById("step-persona").classList.add("hidden");
    document.getElementById("step-licence").classList.remove("hidden");
  }

  function showPersonas() {
    document.getElementById("step-licence").classList.add("hidden");
    document.getElementById("step-persona").classList.remove("hidden");
  }

  function resetFlow() {
    LICENSE = "";
    document.getElementById("license").value = "";
    setStatus("");
    showLicense();
  }

  // Sécurité : on force toujours l'écran licence au chargement
  window.addEventListener("load", () => {
    showLicense();
  });

  async function validateLicense() {
    setStatus("");
    LICENSE = document.getElementById("license").value.trim();

    if (!LICENSE) {
      setStatus("Veuillez entrer un code.", true);
      return;
    }

    try {
      const res = await fetch(N8N_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ license_code: LICENSE })
      });

      const data = await res.json();

      // Si ton n8n renvoie success:false quand pas de crédit / mauvais code
      if (data && data.success === false) {
        setStatus(data.message || "Code invalide / crédit insuffisant.", true);
        return;
      }

      // Sinon on considère que c'est OK
      setStatus("Code validé ✅", false);
      showPersonas();

    } catch (err) {
      console.error(err);
      setStatus("Erreur de connexion au serveur.", true);
    }
  }

  async function choosePersona(persona) {
    // IMPORTANT : ici on ne bloque pas l’UI, on teste juste l’appel
    try {
      const res = await fetch(N8N_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ license_code: LICENSE, persona })
      });

      const data = await res.json();
      alert("Persona choisi ✅\n\n" + JSON.stringify(data, null, 2));

    } catch (err) {
      console.error(err);
      alert("Erreur lors du choix du persona");
    }
  }
</script>
</body>
</html>
